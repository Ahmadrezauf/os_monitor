---
title: "01_zora_preprocessing"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Generating ZORA JSON files

These have been run in advance and then gzipped to save space ..

```{r eval=FALSE}
stub <- "wget -O zora_YEAR.js --no-check-certificate https://www.zora.uzh.ch/cgi/exportview/yearnew/YEAR/JSON/YEAR.js"

z <- 2000:2020

for(i in z) {
  cmd <- gsub("YEAR",i,stub)
  cat(cmd,"\n")
  system(cmd)
}
```

## Load packages

```{r cars}
library(rjson)
library(XML)
library(ggplot2)
library(dplyr)
```


## Reading in ZORA JSON files

```{r cars}
fs <- dir("data", ".js.gz$", full.names = TRUE)

first_na <- function(x, subset=1) {
  x <- x[subset]
  ifelse(is.null(x), NA, x)
}

# pull out some data.frames for each JSON file
df_lists <- lapply(fs, function(u) {
  cat(".")
  this <- fromJSON(file = gzfile(u))
  
  eprintid <- sapply(this, function(u) first_na(u$eprintid))

  dewey <- lapply(this, function(u) as.character(u$dewey))
  n_dewey <- sapply(dewey, length)
  
  tbl_dewey <- data.frame(eprintid=rep(eprintid, n_dewey),
                          dewey = unlist(dewey),
                          stringsAsFactors = FALSE)
  
  orcid <- lapply(this, function(u) {
    unlist(lapply(u$contributor_lookup, function(v) v$orcid))
  })
  n_orcid <- sapply(orcid, length)
  tbl_orcid <- data.frame(eprintid=rep(eprintid, n_orcid),
                          orcid=unlist(orcid),
                          stringsAsFactors = FALSE)
  

  subjects <- lapply(this, function(u) as.character(u$subjects))
  n_subjects <- sapply(subjects, length)
  
  tbl_subjects <- data.frame(eprintid=rep(eprintid, n_subjects),
                             subjects = unlist(subjects),
                             stringsAsFactors = FALSE)
  
  tbl_eprints <- data.frame(eprintid=eprintid,
             date=sapply(this, function(u) substr(first_na(u$date),1,4)),
             doi=sapply(this, function(u) first_na(u$doi)),
             type=sapply(this, function(u) first_na(u$type)),
             refereed=sapply(this, function(u) first_na(u$refereed_set)),
             institution=sapply(this, function(u) first_na(u$institution)),
             oa_status=sapply(this, function(u) first_na(u$oa_status)),
             stringsAsFactors = FALSE)
  list(tbl_dewey = tbl_dewey,
       tbl_subjects = tbl_subjects,
       tbl_eprints = tbl_eprints,
       tbl_orcid = tbl_orcid)
})


tbl_eprints <- do.call(rbind, lapply(df_lists, .subset2, "tbl_eprints"))
tbl_eprints <- tbl_eprints %>% filter(!is.na(oa_status), !is.na(date))
tbl_dewey <- do.call(rbind, lapply(df_lists, .subset2, "tbl_dewey"))
tbl_subjects <- do.call(rbind, lapply(df_lists, .subset2, "tbl_subjects"))
tbl_orcid <- do.call(rbind, lapply(df_lists, .subset2, "tbl_orcid"))

rm(fs, first_na); gc()
```

## Subjects

```{r subjects}
# sub_lookup <- xmlToDataFrame("data/subjects_combined_20200108.xml")
sub_list <- xmlToList("data/subjects_combined_20200108.xml")
sub_df <- data.frame(subjects=sapply(sub_list, .subset2, "subjectid"),
                     name=sapply(sub_list, function(u) u$name[[1]]$name),
                     parent=sapply(sub_list, function(u) u$parents$item),
                     stringsAsFactors = FALSE)
subject_lookup <- setNames(sub_df$name, sub_df$subjects)
sub_df$parent_name <- subject_lookup[sub_df$parent]

tbl_subjects <- tbl_subjects %>% left_join(sub_df)

df <- tbl_subjects %>% left_join(tbl_eprints)
df$oa_status <- factor(df$oa_status, levels=c("closed","hybrid","green","gold"))

nm <- names(sort(table(df$name), decreasing = TRUE)[1:20])

ggplot(df %>% filter(date < 2020, name %in% nm), aes(x=date, fill=oa_status)) + 
  geom_bar() + 
  facet_wrap(~name, scales="free_y", ncol=5) +
  theme(axis.text.x = element_text(angle = 90))


df <- tbl_subjects %>% left_join(tbl_eprints)
df$oa_status <- factor(df$oa_status, levels=c("closed","hybrid","green","gold"))

nm <- names(sort(table(df$parent_name), decreasing = TRUE)[1:15])

ggplot(df %>% filter(date < 2020, parent_name %in% nm), aes(x=date, fill=oa_status)) + 
  geom_bar() + 
  facet_wrap(~parent_name, scales="free_y", ncol=5) +
  theme(axis.text.x = element_text(angle = 90))

```

## Dewey

```{r dewey}
# read in Dewey file to get classifications
dewey_file <- read.table("https://www.gutenberg.org/cache/epub/12513/pg12513.txt", 
                         sep="\n", quote="")
# dewey_list <- grep("^[0-9][0-9]0", dewey_file$V1, value=TRUE)
dewey_list <- grep("^=[0-9][0-9][0-9]", dewey_file$V1, value=TRUE)
dewey_list <- gsub("=","", dewey_list)
dewey_num <- substr(dewey_list, 1, 3)
dewey_cat <- trimws(substr(dewey_list, 5, 200))
dewey_lookup <- setNames(dewey_cat, dewey_num)
rm(dewey_file, dewey_list, dewey_num, dewey_cat)


top_dewey <- names(sort(table(tbl_dewey$dewey), decreasing = TRUE)[1:18])
tbl_dewey <- tbl_dewey %>% dplyr::filter(dewey %in% top_dewey)
tbl_dewey$field <- dewey_lookup[gsub("ddc","", tbl_dewey$dewey)]


df <- tbl_dewey %>% left_join(tbl_eprints)

# ggplot(mydf, aes(x=date, fill=oa_status)) + 
#   geom_bar() + facet_wrap(~oa_status, ncol=1, scales = "free_y")
# ggplot(df, aes(x=date, fill=oa_status)) + 
#   geom_bar() + scale_y_sqrt()

df$oa_status <- factor(df$oa_status, levels=c("closed","hybrid","green","gold"))

ggplot(df %>% filter(date > 2007, date < 2020), aes(x=date, fill=oa_status)) + 
  geom_bar() + 
  facet_wrap(~paste0(gsub("ddc","",dewey),":",field), scales="free_y", ncol=6) +
  theme(axis.text.x = element_text(angle = 90))


```

## ORCID

```{r orcid}

df <- tbl_orcid %>% filter(grepl("0000-0003-3841-6207", orcid)) %>%
  left_join(tbl_eprints)

df$oa_status <- factor(df$oa_status, levels=c("closed","hybrid","green","gold"))

ggplot(df, aes(x=date, fill=oa_status)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 90))


```